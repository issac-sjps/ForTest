<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
      body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f5f5f5; }
      .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
      h2 { color: #333; border-bottom: 2px solid #4285f4; padding-bottom: 10px; }
      .file-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
      .file-item:hover { background-color: #f9f9f9; }
      .file-name { flex-grow: 1; font-weight: bold; }
      .file-path { font-size: 0.8em; color: #666; margin-left: 10px; margin-right: 10px;}
      .qty-input { width: 60px; padding: 5px; margin-right: 10px; text-align: center; }
      .btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-top: 20px; }
      .btn-primary { background-color: #4285f4; color: white; }
      .btn-primary:disabled { background-color: #ccc; cursor: not-allowed; }
      #status { margin-top: 15px; font-weight: bold; color: #d32f2f; }
      .loading { display: none; margin-left: 10px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>ğŸ–¨ï¸ PDF é›²ç«¯æ‰¹æ¬¡åˆ—å°åŠ©æ‰‹</h2>
      <p>è«‹è¼¸å…¥æ¯å€‹æª”æ¡ˆéœ€è¦çš„ä»½æ•¸ï¼Œè‹¥ç‚º 0 å‰‡ä¸åˆ—å°ã€‚æœ€å¾Œé»æ“Šã€Œç”¢ç”Ÿåˆä½µæª”ã€ã€‚</p>
      
      <div id="file-list">
        <p>æ­£åœ¨æƒæ Google Drive è³‡æ–™å¤¾...</p>
      </div>

      <button id="mergeBtn" class="btn btn-primary" onclick="startMerge()" disabled>
        ğŸ“¥ ç”¢ç”Ÿä¸¦ä¸‹è¼‰åˆä½µ PDF
      </button>
      <span id="status"></span>
    </div>

    <script>
      let globalFiles = [];

      // é é¢è¼‰å…¥æ™‚å–å¾—æª”æ¡ˆåˆ—è¡¨
      window.onload = function() {
        google.script.run.withSuccessHandler(showFiles).getAllFiles();
      };

      function showFiles(files) {
        globalFiles = files;
        const listDiv = document.getElementById('file-list');
        listDiv.innerHTML = '';

        if (files.length === 0) {
          listDiv.innerHTML = '<p>è³‡æ–™å¤¾å…§æ‰¾ä¸åˆ° PDF æª”æ¡ˆã€‚</p>';
          return;
        }

        files.forEach((file, index) => {
          const div = document.createElement('div');
          div.className = 'file-item';
          div.innerHTML = `
            <div style="flex-grow:1">
              <span class="file-name">${file.name}</span><br>
              <span class="file-path">ğŸ“‚ ${file.path}</span>
            </div>
            <label>ä»½æ•¸ï¼š</label>
            <input type="number" min="0" value="0" class="qty-input" id="qty-${index}" data-id="${file.id}">
          `;
          listDiv.appendChild(div);
        });
        
        document.getElementById('mergeBtn').disabled = false;
      }

      async function startMerge() {
        const btn = document.getElementById('mergeBtn');
        const status = document.getElementById('status');
        btn.disabled = true;
        status.innerText = 'æ­£åœ¨è™•ç†ä¸­ï¼Œè«‹å‹¿é—œé–‰è¦–çª—... (æª”æ¡ˆå¤šæ™‚éœ€ç­‰å¾…)';

        try {
          // å»ºç«‹ä¸€å€‹æ–°çš„ PDF æ–‡ä»¶
          const { PDFDocument } = PDFLib;
          const mergedPdf = await PDFDocument.create();
          
          let hasFilesToPrint = false;

          // éæ­·æ‰€æœ‰æª”æ¡ˆ
          for (let i = 0; i < globalFiles.length; i++) {
            const qty = parseInt(document.getElementById(`qty-${i}`).value);
            if (qty > 0) {
              hasFilesToPrint = true;
              status.innerText = `æ­£åœ¨ä¸‹è¼‰ä¸¦è™•ç†ï¼š${globalFiles[i].name} (${qty} ä»½)...`;
              
              // å‘¼å«å¾Œç«¯å–å¾—æª”æ¡ˆå…§å®¹ (Base64)
              const base64Data = await new Promise((resolve, reject) => {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .getFileContent(globalFiles[i].id);
              });

              // è¼‰å…¥è©² PDF
              const sourcePdf = await PDFDocument.load(base64Data);
              const copiedPages = await mergedPdf.copyPages(sourcePdf, sourcePdf.getPageIndices());

              // ä¾ç…§ä»½æ•¸é‡è¤‡åŠ å…¥é é¢
              for (let q = 0; q < qty; q++) {
                copiedPages.forEach((page) => mergedPdf.addPage(page));
              }
            }
          }

          if (!hasFilesToPrint) {
            status.innerText = 'âŒ ä½ æ²’æœ‰é¸æ“‡ä»»ä½•éœ€è¦åˆ—å°çš„ä»½æ•¸ã€‚';
            btn.disabled = false;
            return;
          }

          status.innerText = 'æ­£åœ¨ç”Ÿæˆæœ€çµ‚æª”æ¡ˆ...';
          const pdfBytes = await mergedPdf.save();
          downloadBlob(pdfBytes, 'æ‰¹æ¬¡åˆ—å°åˆä½µæª”.pdf');
          
          status.innerText = 'âœ… ä¸‹è¼‰å®Œæˆï¼è«‹é–‹å•Ÿæª”æ¡ˆä¸¦åˆ—å°ã€‚';
          btn.disabled = false;

        } catch (err) {
          console.error(err);
          status.innerText = 'âŒ ç™¼ç”ŸéŒ¯èª¤ï¼š' + err.message;
          btn.disabled = false;
        }
      }

      function downloadBlob(data, fileName) {
        const blob = new Blob([data], { type: 'application/pdf' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.download = fileName;
        link.click();
      }
    </script>
  </body>
</html>
