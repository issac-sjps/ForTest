<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生分班電話名冊產生器</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        [v-cloak] { display: none; }
        
        /* 列印專用樣式 (Print Styles) */
        @media print {
            @page { margin: 1cm; size: A4; }
            body { background: white; -webkit-print-color-adjust: exact; }
            /* 隱藏網頁上的按鈕、輸入框、標題等非列印內容 */
            .no-print, .no-print * { display: none !important; }
            /* 顯示列印區域 */
            #print-area { display: block !important; }
            /* 表格樣式優化 */
            table { width: 100%; border-collapse: collapse; font-size: 12pt; }
            th, td { border: 1px solid black; padding: 6px; text-align: left; }
            th { background-color: #f0f0f0 !important; font-weight: bold; }
            /* 強制分頁：每個班級區塊結束後換頁 */
            .page-break { page-break-after: always; }
            /* 防止表格在列印時被切斷 */
            tr { page-break-inside: avoid; }
        }

        /* 螢幕顯示時隱藏列印區 */
        #print-area { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">
    <div id="app" v-cloak class="p-4 md:p-8 max-w-6xl mx-auto">
        
        <div class="no-print">
            <header class="mb-8 text-center">
                <h1 class="text-3xl font-black text-slate-800 mb-2">學生分班電話名冊產生器</h1>
                <p class="text-slate-500">針對「學生姓名、分發班級」欄位優化，支援一鍵列印</p>
            </header>

            <div v-if="debugMsg.length" class="mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-sm text-yellow-800">
                <h3 class="font-bold mb-1">欄位偵測報告：</h3>
                <ul class="list-disc pl-5"><li v-for="(msg, i) in debugMsg" :key="i">{{ msg }}</li></ul>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-blue-200">
                    <h2 class="text-lg font-bold text-blue-900 mb-2">1. 學生名單</h2>
                    <p class="text-xs text-slate-400 mb-3">需包含：<span class="bg-blue-100 text-blue-800 px-1 rounded">學生姓名</span>、<span class="bg-blue-100 text-blue-800 px-1 rounded">分發班級</span></p>
                    <input type="file" @change="e => handleFileUpload(e, 'listA')" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-emerald-200">
                    <h2 class="text-lg font-bold text-emerald-900 mb-2">2. 電話資料</h2>
                    <p class="text-xs text-slate-400 mb-3">需包含：<span class="bg-emerald-100 text-emerald-800 px-1 rounded">姓名</span>、<span class="bg-emerald-100 text-emerald-800 px-1 rounded">家長一行動電話</span></p>
                    <input type="file" @change="e => handleFileUpload(e, 'listB')" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 cursor-pointer" />
                </div>
            </div>

            <div class="flex flex-col items-center gap-4 mb-10">
                <button @click="processMatching" :disabled="!listA.length || !listB.length" class="bg-indigo-600 text-white px-10 py-3 rounded-lg font-bold hover:bg-indigo-700 disabled:opacity-30 disabled:cursor-not-allowed shadow-lg transition">
                    開始比對資料
                </button>

                <div v-if="results.length" class="flex flex-wrap justify-center gap-4 bg-white p-4 rounded-xl border border-slate-200 shadow-sm w-full">
                    <button @click="printAll" class="flex items-center bg-slate-800 text-white px-6 py-3 rounded-lg hover:bg-slate-900 transition font-bold shadow-md">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        列印全校名冊 (自動分頁)
                    </button>
                    
                    <button @click="downloadExcel" class="flex items-center bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-bold shadow-md">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        下載 Excel 檔案
                    </button>
                </div>
            </div>

            <div v-if="results.length" class="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                <div class="p-4 bg-slate-50 border-b font-bold text-slate-700 flex justify-between">
                    <span>資料預覽 (共 {{ results.length }} 筆)</span>
                    <span class="text-sm font-normal text-slate-500">列印時會自動按班級分頁</span>
                </div>
                <div class="overflow-x-auto max-h-[500px]">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100 sticky top-0">
                            <tr>
                                <th class="p-3 border-b w-24">分發班級</th>
                                <th class="p-3 border-b w-32">學生姓名</th>
                                <th class="p-3 border-b">家長一行動電話</th>
                                <th class="p-3 border-b">家長二行動電話</th>
                                <th class="p-3 border-b text-center w-20">狀態</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(row, idx) in results" :key="idx" :class="idx % 2 === 0 ? 'bg-white' : 'bg-slate-50'">
                                <td class="p-3 font-bold text-slate-600">{{ row.分發班級 }}</td>
                                <td class="p-3 font-bold">{{ row.學生姓名 }}</td>
                                <td class="p-3 font-mono text-blue-600">{{ row.家長一行動電話 }}</td>
                                <td class="p-3 font-mono text-blue-600">{{ row.家長二行動電話 }}</td>
                                <td class="p-3 text-center">
                                    <span v-if="!row.家長一行動電話 && !row.家長二行動電話" class="text-red-500 font-bold">缺</span>
                                    <span v-else class="text-green-500">OK</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="print-area">
            <div v-for="(group, className) in groupedResults" :key="className" class="page-break">
                <div class="mb-4">
                    <h2 class="text-2xl font-bold text-center border-b-2 border-black pb-2 mb-4">
                        {{ className }} 學生聯絡名冊
                    </h2>
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 10%">座號</th>
                                <th style="width: 20%">學生姓名</th>
                                <th style="width: 35%">家長一行動電話</th>
                                <th style="width: 35%">家長二行動電話</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(student, idx) in group" :key="idx">
                                <td class="text-center">{{ idx + 1 }}</td>
                                <td>{{ student.學生姓名 }}</td>
                                <td>{{ student.家長一行動電話 }}</td>
                                <td>{{ student.家長二行動電話 }}</td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="mt-2 text-right text-xs">列印日期：{{ new Date().toLocaleDateString() }}</div>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const listA = ref([]); 
                const listB = ref([]);
                const results = ref([]);
                const debugMsg = ref([]);

                // 智慧欄位讀取
                const getSmartValue = (row, candidates) => {
                    const rowKeys = Object.keys(row);
                    for (let key of rowKeys) {
                        const cleanKey = key.trim().replace(/\s+/g, '');
                        if (candidates.includes(cleanKey)) return row[key];
                    }
                    return undefined;
                };

                const handleFileUpload = (event, target) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const headers = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0];
                            const json = XLSX.utils.sheet_to_json(worksheet);
                            
                            if (target === 'listA') {
                                listA.value = json;
                                debugMsg.value.push(`檔案1 讀取完成，欄位：[${headers.join(', ')}]`);
                            } else {
                                listB.value = json;
                                debugMsg.value.push(`檔案2 讀取完成，欄位：[${headers.join(', ')}]`);
                            }
                        } catch (err) {
                            alert("檔案讀取錯誤");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };

                const processMatching = () => {
                    // 1. 設定欄位關鍵字 (包含你指定的名稱)
                    const nameKeys = ['學生姓名', '姓名', 'Name'];
                    const classKeys = ['分發班級', '班別', '班級', 'Class'];
                    const p1Keys = ['家長一行動電話', '家長一電話', '電話1', '父手機', '母手機'];
                    const p2Keys = ['家長二行動電話', '家長二電話', '電話2'];

                    // 2. 建立電話字典
                    const phoneMap = new Map();
                    listB.value.forEach(item => {
                        const name = getSmartValue(item, nameKeys);
                        if (name) {
                            phoneMap.set(String(name).trim(), {
                                p1: getSmartValue(item, p1Keys) || '',
                                p2: getSmartValue(item, p2Keys) || ''
                            });
                        }
                    });

                    // 3. 執行比對
                    const matched = listA.value.map(student => {
                        const nameVal = getSmartValue(student, nameKeys);
                        const classVal = getSmartValue(student, classKeys);
                        
                        // 如果抓不到分發班級，預設為 "未分類"
                        const className = classVal ? String(classVal).trim() : '未分類';
                        const studentName = nameVal ? String(nameVal).trim() : '';
                        const phones = phoneMap.get(studentName);

                        return {
                            '分發班級': className,
                            '學生姓名': studentName || '無姓名',
                            '家長一行動電話': phones ? phones.p1 : '',
                            '家長二行動電話': phones ? phones.p2 : ''
                        };
                    });

                    // 4. 排序 (先排班級，再排姓名)
                    matched.sort((a, b) => {
                        const clsDiff = a['分發班級'].localeCompare(b['分發班級'], undefined, { numeric: true });
                        if (clsDiff !== 0) return clsDiff;
                        return a['學生姓名'].localeCompare(b['學生姓名']);
                    });

                    results.value = matched;
                    if (matched.length === 0) alert("比對結果為空，請檢查欄位名稱是否正確！");
                    else alert("比對完成！您可以點擊「列印全校名冊」進行分班列印。");
                };

                // 將結果按班級分組 (為了列印分頁)
                const groupedResults = computed(() => {
                    const groups = {};
                    results.value.forEach(row => {
                        const cls = row['分發班級'];
                        if (!groups[cls]) groups[cls] = [];
                        groups[cls].push(row);
                    });
                    return groups;
                });

                const printAll = () => {
                    window.print();
                };

                const downloadExcel = () => {
                    const ws = XLSX.utils.json_to_sheet(results.value);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "名單");
                    XLSX.writeFile(wb, `分班電話名冊_${new Date().toISOString().slice(0,10)}.xlsx`);
                };

                return {
                    listA, listB, results, debugMsg, groupedResults,
                    handleFileUpload, processMatching, printAll, downloadExcel
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
