<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學習扶助-學生聯絡名冊製作工具</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        [v-cloak] { display: none; }
        
        /* 列印專用樣式 (A4 直式優化) */
        @media print {
            @page { margin: 1cm; size: A4 portrait; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .no-print { display: none !important; }
            #print-area { display: block !important; }
            
            /* 表格線條與文字設定 */
            table { width: 100%; border-collapse: collapse; font-family: "Microsoft JhengHei", "PMingLiU", sans-serif; }
            th { background-color: #f3f4f6 !important; color: #000; font-weight: bold; border: 1px solid #000; padding: 4px; font-size: 11pt; }
            td { border: 1px solid #000; padding: 4px 6px; font-size: 11pt; vertical-align: middle; }
            
            /* 班級標題分頁設定 */
            .class-section { page-break-after: always; }
            .class-section:last-child { page-break-after: auto; }
            tr { page-break-inside: avoid; }
        }

        #print-area { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">
    <div id="app" v-cloak class="p-4 md:p-8 max-w-7xl mx-auto">
        
        <div class="no-print">
            <header class="mb-6 text-center">
                <h1 class="text-3xl font-black text-slate-800 mb-2">學習扶助 - 學生聯絡名冊製作</h1>
                <p class="text-slate-500">自動整合「原班級」資訊與「家長電話」，按扶助班級分頁列印</p>
            </header>

            <div v-if="debugMsg.length" class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4 text-sm text-blue-800">
                <h3 class="font-bold mb-1 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    系統偵測報告：
                </h3>
                <ul class="list-disc pl-5 space-y-1 text-xs"><li v-for="(msg, i) in debugMsg" :key="i">{{ msg }}</li></ul>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-indigo-100">
                    <h2 class="text-lg font-bold text-indigo-900 mb-2 flex items-center">
                        <span class="bg-indigo-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm mr-2">1</span>
                        學生名單 (含原班級)
                    </h2>
                    <p class="text-xs text-slate-500 mb-3 leading-relaxed">
                        需包含欄位：<br>
                        <span class="inline-block bg-slate-100 px-1 rounded border border-slate-200">學生姓名</span>
                        <span class="inline-block bg-slate-100 px-1 rounded border border-slate-200 ml-1">分發班級</span> (扶助班)<br>
                        <span class="inline-block bg-indigo-50 text-indigo-700 px-1 rounded border border-indigo-200">原年級</span>
                        <span class="inline-block bg-indigo-50 text-indigo-700 px-1 rounded border border-indigo-200 ml-1">原班級</span>
                    </p>
                    <input type="file" @change="e => handleFileUpload(e, 'listA')" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer" />
                </div>

                <div class="bg-white p-5 rounded-xl shadow-sm border border-emerald-100">
                    <h2 class="text-lg font-bold text-emerald-900 mb-2 flex items-center">
                        <span class="bg-emerald-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-sm mr-2">2</span>
                        電話資料庫
                    </h2>
                    <p class="text-xs text-slate-500 mb-3 leading-relaxed">
                        需包含欄位：<br>
                        <span class="inline-block bg-slate-100 px-1 rounded border border-slate-200">姓名</span>
                        <span class="inline-block bg-emerald-50 text-emerald-700 px-1 rounded border border-emerald-200 ml-1">家長一行動電話</span>
                        <span class="inline-block bg-emerald-50 text-emerald-700 px-1 rounded border border-emerald-200 ml-1">家長二行動電話</span>
                    </p>
                    <input type="file" @change="e => handleFileUpload(e, 'listB')" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 cursor-pointer" />
                </div>
            </div>

            <div class="flex flex-col items-center justify-center gap-4 mb-8">
                <button @click="processMatching" :disabled="!listA.length || !listB.length" 
                    class="bg-slate-800 text-white px-10 py-3 rounded-lg font-bold hover:bg-slate-700 disabled:opacity-30 disabled:cursor-not-allowed shadow-lg transition">
                    開始比對資料
                </button>

                <div v-if="results.length" class="flex flex-wrap gap-3 bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                    <button @click="printAll" class="flex items-center bg-indigo-600 text-white px-5 py-2 rounded hover:bg-indigo-700 transition font-bold shadow">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        列印學習扶助名冊 (按班分頁)
                    </button>
                    <button @click="downloadExcel" class="flex items-center bg-green-600 text-white px-5 py-2 rounded hover:bg-green-700 transition font-bold shadow">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        下載 Excel
                    </button>
                </div>
            </div>

            <div v-if="results.length" class="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
                <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                    <span class="font-bold text-slate-700">資料預覽 (前 50 筆)</span>
                    <span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">列印時會顯示完整資料</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-100 text-slate-600">
                            <tr>
                                <th class="p-3 whitespace-nowrap">分發班級</th>
                                <th class="p-3 whitespace-nowrap">原班級</th>
                                <th class="p-3 whitespace-nowrap">學生姓名</th>
                                <th class="p-3 whitespace-nowrap">家長一電話</th>
                                <th class="p-3 whitespace-nowrap">家長二電話</th>
                                <th class="p-3 text-center whitespace-nowrap">狀態</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr v-for="(row, idx) in results.slice(0, 50)" :key="idx" class="hover:bg-slate-50">
                                <td class="p-3 font-bold text-slate-600">{{ row.分發班級 }}</td>
                                <td class="p-3 text-slate-500">{{ row.原年級 }}年 {{ row.原班級 }}班</td>
                                <td class="p-3 font-bold">{{ row.學生姓名 }}</td>
                                <td class="p-3 font-mono text-blue-600">{{ row.家長一行動電話 }}</td>
                                <td class="p-3 font-mono text-blue-600">{{ row.家長二行動電話 }}</td>
                                <td class="p-3 text-center">
                                    <span v-if="row.家長一行動電話" class="text-green-500 text-xs">●</span>
                                    <span v-else class="text-red-400 text-xs">缺</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="print-area">
            <div v-for="(group, className) in groupedResults" :key="className" class="class-section">
                <div class="mb-4">
                    <h2 class="text-2xl font-bold text-center mb-1">{{ className }} 學生聯絡名冊</h2>
                    <p class="text-center text-sm text-gray-500 mb-4 border-b pb-2 border-black">
                        (學習扶助專用) 列印日期：{{ new Date().toLocaleDateString() }}
                    </p>
                    
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th style="width: 8%">座號</th>
                                <th style="width: 15%">原班級</th>
                                <th style="width: 17%">學生姓名</th>
                                <th style="width: 30%">家長一行動電話</th>
                                <th style="width: 30%">家長二行動電話</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(student, idx) in group" :key="idx">
                                <td class="text-center">{{ idx + 1 }}</td>
                                <td class="text-center">{{ student.原年級 }}年 {{ student.原班級 }}班</td>
                                <td class="text-center font-bold">{{ student.學生姓名 }}</td>
                                <td>{{ student.家長一行動電話 }}</td>
                                <td>{{ student.家長二行動電話 }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="mt-2 text-right text-[10pt] text-gray-400">
                    第 {{ idx + 1 }} 頁
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const listA = ref([]); 
                const listB = ref([]);
                const results = ref([]);
                const debugMsg = ref([]);

                // 智慧欄位讀取 (自動去除空白)
                const getSmartValue = (row, candidates) => {
                    const rowKeys = Object.keys(row);
                    for (let key of rowKeys) {
                        const cleanKey = key.trim().replace(/\s+/g, '');
                        if (candidates.includes(cleanKey)) return row[key];
                    }
                    return undefined;
                };

                const handleFileUpload = (event, target) => {
                    const file = event.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            const headers = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0];
                            const json = XLSX.utils.sheet_to_json(worksheet);
                            
                            if (target === 'listA') {
                                listA.value = json;
                                debugMsg.value.push(`檔案1 讀取: 偵測到 ${json.length} 筆資料，標題: [${headers.join(', ')}]`);
                            } else {
                                listB.value = json;
                                debugMsg.value.push(`檔案2 讀取: 偵測到 ${json.length} 筆資料，標題: [${headers.join(', ')}]`);
                            }
                        } catch (err) {
                            alert("檔案讀取失敗，請確認是否為有效的 Excel 檔");
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };

                const processMatching = () => {
                    // 設定關鍵字 (支援模糊比對)
                    const keys = {
                        name: ['學生姓名', '姓名', 'Name'],
                        distClass: ['分發班級', '班級', 'Class', '扶助班級'],
                        origGrade: ['原年級', '年級', 'Grade'],
                        origClass: ['原班級', '原班', '班'],
                        p1: ['家長一行動電話', '家長一電話', '電話1', '父手機', '母手機'],
                        p2: ['家長二行動電話', '家長二電話', '電話2']
                    };

                    const phoneMap = new Map();
                    // 建立電話字典
                    listB.value.forEach(item => {
                        const name = getSmartValue(item, keys.name);
                        if (name) {
                            phoneMap.set(String(name).trim(), {
                                p1: getSmartValue(item, keys.p1) || '',
                                p2: getSmartValue(item, keys.p2) || ''
                            });
                        }
                    });

                    // 執行比對
                    let matched = listA.value.map(student => {
                        const nameVal = getSmartValue(student, keys.name);
                        const sName = nameVal ? String(nameVal).trim() : '';
                        const phones = phoneMap.get(sName);

                        return {
                            '分發班級': String(getSmartValue(student, keys.distClass) || '未分類').trim(),
                            '原年級': getSmartValue(student, keys.origGrade) || '',
                            '原班級': getSmartValue(student, keys.origClass) || '',
                            '學生姓名': sName || '無姓名',
                            '家長一行動電話': phones ? phones.p1 : '',
                            '家長二行動電話': phones ? phones.p2 : ''
                        };
                    });

                    // 排序：先排分發班級 -> 再排原年級 -> 再排原班級 -> 最後排姓名
                    matched.sort((a, b) => {
                        const distDiff = a['分發班級'].localeCompare(b['分發班級'], undefined, { numeric: true });
                        if (distDiff !== 0) return distDiff;
                        
                        // 嘗試將年級轉為數字比較
                        const gA = parseInt(a['原年級']) || 0;
                        const gB = parseInt(b['原年級']) || 0;
                        if (gA !== gB) return gA - gB;

                        const cA = parseInt(a['原班級']) || 0;
                        const cB = parseInt(b['原班級']) || 0;
                        if (cA !== cB) return cA - cB;

                        return a['學生姓名'].localeCompare(b['學生姓名']);
                    });

                    results.value = matched;
                    if(matched.length > 0) alert("比對完成！請點擊「列印」按鈕查看列印版面。");
                };

                const groupedResults = computed(() => {
                    const groups = {};
                    results.value.forEach(row => {
                        const cls = row['分發班級'];
                        if (!groups[cls]) groups[cls] = [];
                        groups[cls].push(row);
                    });
                    return groups;
                });

                const printAll = () => window.print();

                const downloadExcel = () => {
                    const ws = XLSX.utils.json_to_sheet(results.value);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "學習扶助名冊");
                    XLSX.writeFile(wb, `扶助班電話名冊_${new Date().toISOString().slice(0,10)}.xlsx`);
                };

                return {
                    listA, listB, results, debugMsg, groupedResults,
                    handleFileUpload, processMatching, printAll, downloadExcel
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
