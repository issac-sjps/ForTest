<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>學生聯絡資訊比對工具 (智慧除錯版)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">
    <div id="app" v-cloak class="p-4 md:p-8 max-w-6xl mx-auto">
        
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-black text-slate-800 mb-2">學生電話抓取工具 (智慧對應版)</h1>
            <p class="text-slate-500">自動去除欄位空白，支援模糊比對</p>
        </header>

        <div v-if="debugMsg.length" class="mb-6 bg-amber-50 border border-amber-200 rounded-lg p-4 text-sm text-amber-900">
            <h3 class="font-bold flex items-center mb-2">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                檔案欄位診斷報告 (如果下方顯示空白，請檢查這裡)
            </h3>
            <ul class="list-disc pl-5 space-y-1">
                <li v-for="(msg, idx) in debugMsg" :key="idx">{{ msg }}</li>
            </ul>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-blue-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-blue-900">1. 學生名單</h2>
                    <span v-if="headersA.length" class="text-xs bg-gray-100 px-2 py-1 rounded">偵測到標題: {{ headersA.join(', ') }}</span>
                </div>
                <input type="file" @change="e => handleFileUpload(e, 'listA')" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer" />
            </div>

            <div class="bg-white p-6 rounded-xl shadow-sm border border-emerald-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-emerald-900">2. 電話資料</h2>
                    <span v-if="headersB.length" class="text-xs bg-gray-100 px-2 py-1 rounded">偵測到標題: {{ headersB.join(', ') }}</span>
                </div>
                <input type="file" @change="e => handleFileUpload(e, 'listB')" accept=".xlsx, .xls" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 cursor-pointer" />
            </div>
        </div>

        <div class="text-center mb-10">
            <button @click="processMatching" :disabled="!listA.length || !listB.length" class="bg-indigo-600 text-white px-10 py-3 rounded-lg font-bold hover:bg-indigo-700 disabled:opacity-30 disabled:cursor-not-allowed transition shadow-lg">
                開始智慧比對
            </button>
            <div class="mt-4 space-x-2" v-if="results.length">
                 <button @click="downloadAll" class="bg-slate-800 text-white px-4 py-2 rounded hover:bg-slate-900 text-sm">下載全部</button>
                 <select v-model="selectedClass" class="border p-2 rounded text-sm">
                    <option value="">選擇班級下載...</option>
                    <option v-for="cls in availableClasses" :key="cls" :value="cls">{{ cls }}</option>
                 </select>
                 <button @click="downloadSingleClass" :disabled="!selectedClass" class="bg-emerald-600 text-white px-4 py-2 rounded hover:bg-emerald-700 text-sm disabled:opacity-50">下載該班</button>
            </div>
        </div>

        <div v-if="results.length" class="bg-white rounded-xl shadow border border-slate-200 overflow-hidden">
            <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                <h3 class="font-bold text-slate-700">比對預覽</h3>
                <div class="text-sm">
                    <span class="text-green-600 mr-4 font-bold">成功: {{ stats.found }}</span>
                    <span class="text-red-500 font-bold">缺漏: {{ stats.missing }}</span>
                </div>
            </div>
            <div class="overflow-x-auto max-h-[500px]">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-100 sticky top-0">
                        <tr>
                            <th class="p-3 border-b">班別</th>
                            <th class="p-3 border-b">姓名</th>
                            <th class="p-3 border-b">家長一電話</th>
                            <th class="p-3 border-b">家長二電話</th>
                            <th class="p-3 border-b text-center">狀態</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
                        <tr v-for="(row, idx) in results" :key="idx" class="hover:bg-blue-50">
                            <td class="p-3">{{ row.班別 }}</td>
                            <td class="p-3 font-medium">{{ row.姓名 }}</td>
                            <td class="p-3 text-blue-600 font-mono">{{ row.家長一行動電話 }}</td>
                            <td class="p-3 text-blue-600 font-mono">{{ row.家長二行動電話 }}</td>
                            <td class="p-3 text-center">
                                <span v-if="row.家長一行動電話" class="text-green-500">●</span>
                                <span v-else class="text-red-300">●</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const listA = ref([]); 
                const listB = ref([]); 
                const headersA = ref([]);
                const headersB = ref([]);
                const results = ref([]);
                const debugMsg = ref([]);
                const selectedClass = ref("");

                // 智慧讀取欄位工具
                const getSmartValue = (row, candidates) => {
                    const rowKeys = Object.keys(row);
                    // 1. 先找完全符合的
                    for (let key of rowKeys) {
                        if (candidates.includes(key)) return row[key];
                    }
                    // 2. 去除空白後比對 (例如 "姓名 " -> "姓名")
                    for (let key of rowKeys) {
                        const cleanKey = key.trim().replace(/\s+/g, ''); 
                        if (candidates.includes(cleanKey)) return row[key];
                    }
                    return undefined;
                };

                const handleFileUpload = (event, target) => {
                    const file = event.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                            // header: 1 代表讀取第一列作為陣列，用來偵測標題
                            const rawHeader = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0];
                            const json = XLSX.utils.sheet_to_json(worksheet); // 正常讀取

                            if (target === 'listA') {
                                listA.value = json;
                                headersA.value = rawHeader || [];
                                debugMsg.value.push(`檔案1 讀取成功，偵測到的欄位: [${rawHeader.join(', ')}]`);
                            } else {
                                listB.value = json;
                                headersB.value = rawHeader || [];
                                debugMsg.value.push(`檔案2 讀取成功，偵測到的欄位: [${rawHeader.join(', ')}]`);
                            }
                        } catch (err) {
                            alert("檔案讀取失敗，請確認格式是否正確");
                            console.error(err);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                };

                const processMatching = () => {
                    debugMsg.value = []; // 清空舊訊息
                    const phoneMap = new Map();

                    // 定義我們接受的欄位別名 (只要符合其中一個就會抓)
                    const nameKeys = ['姓名', '學生姓名', '名字', 'Name'];
                    const classKeys = ['班別', '班級', '班號', 'Class', '年班'];
                    const p1Keys = ['家長一行動電話', '家長一電話', '電話1', '家長1行動電話', '父手機', '母手機'];
                    const p2Keys = ['家長二行動電話', '家長二電話', '電話2', '家長2行動電話'];

                    // 1. 建立電話索引
                    let bCount = 0;
                    listB.value.forEach(item => {
                        const name = getSmartValue(item, nameKeys);
                        if (name) {
                            const cleanName = String(name).trim();
                            phoneMap.set(cleanName, {
                                p1: getSmartValue(item, p1Keys) || '',
                                p2: getSmartValue(item, p2Keys) || ''
                            });
                            bCount++;
                        }
                    });
                    
                    if (bCount === 0) {
                        debugMsg.value.push("⚠️ 警告：在電話檔案中找不到「姓名」欄位，請檢查上方偵測到的標題是否正確。");
                    }

                    // 2. 比對
                    let aCount = 0;
                    const matched = listA.value.map(student => {
                        const nameVal = getSmartValue(student, nameKeys);
                        const classVal = getSmartValue(student, classKeys);

                        if (!nameVal) aCount++; // 統計抓不到名字的數量

                        const sName = nameVal ? String(nameVal).trim() : '未命名';
                        const info = phoneMap.get(sName);

                        return {
                            '班別': classVal || '未分類',
                            '姓名': sName,
                            '家長一行動電話': info ? info.p1 : '',
                            '家長二行動電話': info ? info.p2 : ''
                        };
                    });

                    if (aCount === listA.value.length) {
                         debugMsg.value.push("❌ 錯誤：在學生名單中完全抓不到「姓名」欄位！請檢查 Excel 標題是否為「姓名」或「學生姓名」。");
                    }

                    matched.sort((a, b) => String(a.班別).localeCompare(String(b.班別), undefined, { numeric: true }));
                    results.value = matched;
                };

                const availableClasses = computed(() => [...new Set(results.value.map(r => r.班別))].filter(c => c !== '未分類'));
                
                const stats = computed(() => {
                    const found = results.value.filter(r => r.家長一行動電話).length;
                    return { found, missing: results.value.length - found };
                });

                const exportExcel = (data, name) => {
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Result");
                    XLSX.writeFile(wb, `${name}_${new Date().getTime()}.xlsx`);
                };

                return {
                    listA, listB, headersA, headersB, results, debugMsg,
                    selectedClass, availableClasses, stats,
                    handleFileUpload, processMatching, 
                    downloadAll: () => exportExcel(results.value, '全部資料'),
                    downloadSingleClass: () => {
                        const data = results.value.filter(r => r.班別 === selectedClass.value);
                        exportExcel(data, `${selectedClass.value}班資料`);
                    }
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
