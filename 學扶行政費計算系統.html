<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>06 å­¸æ‰¶ç¶“è²»ä½¿ç”¨ç´€éŒ„ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
            --text-color: #333;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); margin: 0; display: flex; height: 100vh; color: var(--text-color); }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 250px; background-color: var(--primary-color); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar h2 { font-size: 1.2rem; margin-bottom: 30px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
        .nav-btn { background: none; border: none; color: rgba(255,255,255,0.7); padding: 15px; text-align: left; cursor: pointer; font-size: 1rem; transition: 0.3s; border-radius: 5px; margin-bottom: 5px; }
        .nav-btn:hover, .nav-btn.active { background-color: var(--accent-color); color: white; font-weight: bold; }

        /* ä¸»å…§å®¹å€ */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡èˆ‡å„€è¡¨æ¿ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border-left: 5px solid var(--accent-color); }
        .card h3 { margin-top: 0; color: #7f8c8d; font-size: 0.9rem; }
        .card .value { font-size: 1.8rem; font-weight: bold; color: var(--primary-color); }
        .card .sub-value { font-size: 0.85rem; color: #7f8c8d; margin-top: 5px; }

        /* è¡¨æ ¼æ¨£å¼ */
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-top: 20px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; }
        tr:hover { background-color: #f1f1f1; }
        
        /* è¡¨å–®èˆ‡æŒ‰éˆ• */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-primary { background-color: var(--accent-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-secondary { background-color: #95a5a6; }
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* è¨­å®šé é¢è¼¸å…¥æ¡† */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

        /* åˆ—å°æ¨£å¼ (å°é ˜æ¸…å†Šå°ˆç”¨) */
        @media print {
            .sidebar, .action-bar, .no-print { display: none !important; }
            .main-content { padding: 0; margin: 0; overflow: visible; }
            body { background: white; color: black; height: auto; display: block; }
            table { box-shadow: none; border: 1px solid black; width: 100%; font-size: 12pt; }
            th, td { border: 1px solid black; padding: 8px; color: black; }
            th { background-color: #ddd !important; -webkit-print-color-adjust: exact; }
            
            /* éš±è—æ¶ˆè²»é‡‘é¡(æ ¸éŠ·)ï¼Œåªé¡¯ç¤ºè«‹é ˜é‡‘é¡ */
            .col-actual-cost { display: none; }
            
            /* ç°½åæ¬„ä½åœ¨åˆ—å°æ™‚é¡¯ç¤º */
            .print-signature { display: table-cell !important; width: 100px; }
            
            h2.page-title { text-align: center; font-size: 18pt; margin-bottom: 20px; }
            .print-footer { position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 10pt; margin-top: 20px; }
        }

        .print-signature { display: none; } /* è¢å¹•ä¸Šä¸é¡¯ç¤ºç°½åæ¬„ */
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>å­¸æ‰¶ç¶“è²»ç´€éŒ„ç³»çµ±</h2>
        <button class="nav-btn active" onclick="showPage('dashboard')">ğŸ“Š ç¸½è¦½å„€è¡¨æ¿</button>
        <button class="nav-btn" onclick="showPage('summer')">â˜€ï¸ æš‘æœŸç¶“è²»</button>
        <button class="nav-btn" onclick="showPage('sem1')">ğŸ‚ ä¸Šå­¸æœŸç¶“è²»</button>
        <button class="nav-btn" onclick="showPage('winter')">â„ï¸ å¯’å‡ç¶“è²»</button>
        <button class="nav-btn" onclick="showPage('sem2')">ğŸŒ± ä¸‹å­¸æœŸç¶“è²»</button>
        <div style="flex:1"></div>
        <button class="nav-btn" onclick="showPage('settings')">âš™ï¸ è¡Œæ”¿è²»è¨­å®š</button>
        <button class="nav-btn" onclick="showPage('backup')">ğŸ’¾ å‚™ä»½èˆ‡é‚„åŸ</button>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="page active">
            <h1>ç¶“è²»ä½¿ç”¨ç¸½è¦½</h1>
            <div class="dashboard-grid" id="dashboard-cards">
                </div>
            
            <div class="card" style="margin-top:20px;">
                <h3>ğŸ’° å…¨å¹´åº¦ç¸½è¨ˆ</h3>
                <div style="display:flex; justify-content:space-around; margin-top:15px;">
                    <div><span style="font-size:1rem; color:#7f8c8d;">ç¸½é ç®— (è¡Œæ”¿è²»)</span><br><span id="total-budget" class="value">0</span></div>
                    <div><span style="font-size:1rem; color:#7f8c8d;">ç¸½è«‹é ˜ (ç™¼çµ¦è€å¸«)</span><br><span id="total-claim" class="value" style="color:var(--accent-color)">0</span></div>
                    <div><span style="font-size:1rem; color:#7f8c8d;">ç¸½æ¶ˆè²» (å¯¦éš›æ ¸éŠ·)</span><br><span id="total-cost" class="value" style="color:var(--danger-color)">0</span></div>
                    <div><span style="font-size:1rem; color:#7f8c8d;">ç¸½çµé¤˜</span><br><span id="total-balance" class="value" style="color:var(--success-color)">0</span></div>
                </div>
            </div>
        </div>

        <div id="period-template" style="display:none;">
            <div class="action-bar">
                <h2 class="page-title">ç¶“è²»æ˜ç´°</h2>
                <div>
                    <button class="btn btn-primary no-print" onclick="openAddModal()">â• æ–°å¢å“é …</button>
                    <button class="btn btn-secondary no-print" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å°é ˜æ¸…å†Š</button>
                </div>
            </div>

            <div class="card no-print" style="margin-bottom:20px; background:#eaf2f8; border-left-color: var(--primary-color);">
                <span style="margin-right:20px;"><b>è¡Œæ”¿é ç®—ï¼š</b> $<span class="p-budget">0</span></span>
                <span style="margin-right:20px;"><b>å·²è«‹é ˜(ç™¼å‡º)ï¼š</b> $<span class="p-claim">0</span></span>
                <span style="margin-right:20px;"><b>å¯¦éš›æ ¸éŠ·ï¼š</b> $<span class="p-cost">0</span></span>
                <span><b>å‰©é¤˜é¡åº¦ï¼š</b> $<span class="p-balance">0</span></span>
            </div>

            <table id="data-table">
                <thead>
                    <tr>
                        <th width="10%">æ—¥æœŸ</th>
                        <th width="25%">æ‘˜è¦/å“é …</th>
                        <th width="15%">é ˜æ¬¾äºº/å°è±¡</th>
                        <th width="10%">æ•¸é‡</th>
                        <th width="10%">è«‹é ˜é‡‘é¡<br><small>(ç™¼çµ¦è€å¸«)</small></th>
                        <th width="10%" class="col-actual-cost">æ¶ˆè²»é‡‘é¡<br><small>(å¯¦éš›æ ¸éŠ·)</small></th>
                        <th width="10%" class="print-signature">ç°½æ”¶</th>
                        <th width="10%" class="no-print">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
            
            <div class="print-footer" style="display:none;">
                <p>æ‰¿è¾¦äººï¼š___________ &nbsp;&nbsp;&nbsp; ä¸»ä»»ï¼š___________ &nbsp;&nbsp;&nbsp; æ ¡é•·ï¼š___________</p>
            </div>
        </div>

        <div id="summer" class="page period-page"></div>
        <div id="sem1" class="page period-page"></div>
        <div id="winter" class="page period-page"></div>
        <div id="sem2" class="page period-page"></div>

        <div id="settings" class="page">
            <h1>âš™ï¸ è¡Œæ”¿è²»é ç®—è¨­å®š</h1>
            <div class="card settings-grid">
                <div class="form-group">
                    <label>â˜€ï¸ æš‘æœŸ è¡Œæ”¿è²»é ç®—</label>
                    <input type="number" id="set-summer" onchange="updateSettings()">
                </div>
                <div class="form-group">
                    <label>ğŸ‚ ä¸Šå­¸æœŸ è¡Œæ”¿è²»é ç®—</label>
                    <input type="number" id="set-sem1" onchange="updateSettings()">
                </div>
                <div class="form-group">
                    <label>â„ï¸ å¯’å‡ è¡Œæ”¿è²»é ç®—</label>
                    <input type="number" id="set-winter" onchange="updateSettings()">
                </div>
                <div class="form-group">
                    <label>ğŸŒ± ä¸‹å­¸æœŸ è¡Œæ”¿è²»é ç®—</label>
                    <input type="number" id="set-sem2" onchange="updateSettings()">
                </div>
            </div>
        </div>

        <div id="backup" class="page">
            <h1>ğŸ’¾ è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h1>
            
            <div class="card" style="margin-bottom: 20px;">
                <h3>ğŸ“¥ åŒ¯å…¥è³‡æ–™</h3>
                <p>æ”¯æ´ JSON å‚™ä»½æª”æˆ–æ˜¯ Excel æª” (éœ€ç¬¦åˆæ¬„ä½æ ¼å¼)ã€‚</p>
                <input type="file" id="fileInput" accept=".json, .xlsx, .xls" style="margin-bottom:10px;">
                <button class="btn btn-primary" onclick="importData()">è®€å–æª”æ¡ˆ</button>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <h3>ğŸ“¤ åŒ¯å‡ºå‚™ä»½</h3>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-success" onclick="exportJSON()">ä¸‹è¼‰ JSON (æ¨è–¦ï¼Œç¶²é å°ˆç”¨)</button>
                    <button class="btn btn-success" onclick="exportExcel()">ä¸‹è¼‰ Excel (æœ¬åœ°æŸ¥çœ‹ç”¨)</button>
                </div>
            </div>

            <div class="card" style="border-left-color: var(--danger-color);">
                <h3>âš ï¸ å±éšªå€åŸŸ</h3>
                <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ ä¸€éµæ¸…ç©ºé‡è£½æ‰€æœ‰è³‡æ–™</button>
            </div>
        </div>

    </div>

    <script>
        // è³‡æ–™çµæ§‹åˆå§‹åŒ–
        const defaultData = {
            settings: { summer: 0, sem1: 0, winter: 0, sem2: 0 },
            records: {
                summer: [], // {id, date, item, person, qty, claim, cost}
                sem1: [],
                winter: [],
                sem2: []
            }
        };

        let appData = JSON.parse(localStorage.getItem('schoolFundData')) || JSON.parse(JSON.stringify(defaultData));
        let currentPeriod = 'summer'; // ç•¶å‰æª¢è¦–çš„å­¸æœŸ

        // åˆå§‹åŒ–
        window.onload = function() {
            renderDashboard();
            loadSettings();
            renderAllPeriods();
        };

        // é é¢åˆ‡æ›
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // è™•ç† Period é é¢é¡¯ç¤º
            if(['summer', 'sem1', 'winter', 'sem2'].includes(pageId)) {
                currentPeriod = pageId;
                renderPeriodPage(pageId);
                document.getElementById(pageId).classList.add('active');
            } else {
                document.getElementById(pageId).classList.add('active');
                if(pageId === 'dashboard') renderDashboard();
            }

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            const btnMap = {'dashboard':0, 'summer':1, 'sem1':2, 'winter':3, 'sem2':4, 'settings':6, 'backup':7};
            if(document.querySelectorAll('.nav-btn')[btnMap[pageId]]) {
                document.querySelectorAll('.nav-btn')[btnMap[pageId]].classList.add('active');
            }
        }

        // æ¸²æŸ“å„€è¡¨æ¿
        function renderDashboard() {
            const periods = [
                {k:'summer', name:'â˜€ï¸ æš‘æœŸ'}, {k:'sem1', name:'ğŸ‚ ä¸Šå­¸æœŸ'},
                {k:'winter', name:'â„ï¸ å¯’å‡'}, {k:'sem2', name:'ğŸŒ± ä¸‹å­¸æœŸ'}
            ];
            
            let html = '';
            let totalB = 0, totalClaim = 0, totalCost = 0;

            periods.forEach(p => {
                const budget = parseFloat(appData.settings[p.k]) || 0;
                const recs = appData.records[p.k];
                const claim = recs.reduce((sum, r) => sum + (parseFloat(r.claim)||0), 0);
                const cost = recs.reduce((sum, r) => sum + (parseFloat(r.cost)||0), 0);
                const bal = budget - cost;

                totalB += budget; totalClaim += claim; totalCost += cost;

                html += `
                <div class="card">
                    <h3>${p.name}</h3>
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span>é ç®—: $${budget}</span>
                        <span style="color:${bal >= 0 ? 'green':'red'}">é¤˜: $${bal}</span>
                    </div>
                    <div class="value">$${cost} <span style="font-size:0.8rem; color:#ccc;">(å·²æ ¸éŠ·)</span></div>
                    <div class="sub-value">è«‹é ˜é‡‘é¡: $${claim}</div>
                </div>`;
            });

            document.getElementById('dashboard-cards').innerHTML = html;
            document.getElementById('total-budget').innerText = totalB;
            document.getElementById('total-claim').innerText = totalClaim;
            document.getElementById('total-cost').innerText = totalCost;
            document.getElementById('total-balance').innerText = totalB - totalCost;
        }

        // æ¸²æŸ“å„æœŸé é¢
        function renderAllPeriods() {
            ['summer', 'sem1', 'winter', 'sem2'].forEach(p => renderPeriodPage(p));
        }

        function renderPeriodPage(period) {
            const container = document.getElementById(period);
            const template = document.getElementById('period-template').innerHTML;
            const periodName = {'summer':'æš‘æœŸ', 'sem1':'ä¸Šå­¸æœŸ', 'winter':'å¯’å‡', 'sem2':'ä¸‹å­¸æœŸ'}[period];
            
            // ç°¡å–®çš„æ¨¡æ¿æ›¿æ› (è‹¥å°šæœªåˆå§‹åŒ–)
            if(!container.innerHTML) {
                container.innerHTML = template;
                container.querySelector('.page-title').innerText = periodName + " ç¶“è²»æ˜ç´°";
                
                // ç¶å®šæŒ‰éˆ•äº‹ä»¶
                const addBtn = container.querySelector('.btn-primary');
                addBtn.onclick = () => addItem(period);
            }

            // è¨ˆç®—çµ±è¨ˆ
            const budget = parseFloat(appData.settings[period]) || 0;
            const records = appData.records[period];
            const claim = records.reduce((s, r) => s + (parseFloat(r.claim)||0), 0);
            const cost = records.reduce((s, r) => s + (parseFloat(r.cost)||0), 0);

            container.querySelector('.p-budget').innerText = budget;
            container.querySelector('.p-claim').innerText = claim;
            container.querySelector('.p-cost').innerText = cost;
            container.querySelector('.p-balance').innerText = budget - cost;

            // æ¸²æŸ“è¡¨æ ¼
            const tbody = container.querySelector('tbody');
            tbody.innerHTML = '';
            records.forEach((r, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="date" value="${r.date}" onchange="updateRecord('${period}', ${index}, 'date', this.value)"></td>
                    <td><input type="text" value="${r.item}" onchange="updateRecord('${period}', ${index}, 'item', this.value)"></td>
                    <td><input type="text" value="${r.person}" onchange="updateRecord('${period}', ${index}, 'person', this.value)"></td>
                    <td><input type="number" value="${r.qty}" style="width:50px" onchange="updateRecord('${period}', ${index}, 'qty', this.value)"></td>
                    <td><input type="number" value="${r.claim}" onchange="updateRecord('${period}', ${index}, 'claim', this.value)"></td>
                    <td class="col-actual-cost"><input type="number" value="${r.cost}" onchange="updateRecord('${period}', ${index}, 'cost', this.value)"></td>
                    <td class="print-signature"></td>
                    <td class="no-print"><button class="btn btn-danger btn-sm" style="padding:5px 10px;" onclick="deleteRecord('${period}', ${index})">Ã—</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // è³‡æ–™æ“ä½œ
        function addItem(period) {
            appData.records[period].push({
                date: new Date().toISOString().split('T')[0],
                item: '', person: '', qty: 1, claim: 0, cost: 0
            });
            saveData();
            renderPeriodPage(period);
        }

        function updateRecord(period, index, field, value) {
            appData.records[period][index][field] = value;
            saveData();
            // åªæ›´æ–°çµ±è¨ˆæ•¸æ“šï¼Œä¸é‡ç¹ªæ•´å€‹è¡¨æ ¼ä»¥å…å¤±å»ç„¦é»
            renderPeriodPage(period); 
            // è‹¥è¦æœ€ä½³åŒ–é«”é©—ï¼Œæ‡‰åªæ›´æ–°çµ±è¨ˆDOMï¼Œé€™è£¡ç°¡åŒ–è™•ç†é‡ç¹ªæœƒå°è‡´ç„¦é»è·‘æ‰ï¼Œå»ºè­°å¯¦éš›è¼¸å…¥æ™‚æ”¹ç”¨ blur äº‹ä»¶æˆ–é‡å°æ€§æ›´æ–°
            // ä¿®æ­£ï¼šç‚ºäº†è¼¸å…¥æµæš¢ï¼Œé€™è£¡æš«ä¸é‡ç¹ªï¼Œåƒ…å­˜æª”ã€‚é›¢é–‹é é¢æˆ–åˆ‡æ›æ™‚æœƒé‡ç¹ªã€‚
            // ä½†ç‚ºäº†å³æ™‚çœ‹åˆ°çµ±è¨ˆè®ŠåŒ–ï¼Œæˆ‘å€‘æ‰‹å‹•æ›´æ–°çµ±è¨ˆæ¬„ä½
            const budget = parseFloat(appData.settings[period]) || 0;
            const records = appData.records[period];
            const claim = records.reduce((s, r) => s + (parseFloat(r.claim)||0), 0);
            const cost = records.reduce((s, r) => s + (parseFloat(r.cost)||0), 0);
            const container = document.getElementById(period);
            container.querySelector('.p-claim').innerText = claim;
            container.querySelector('.p-cost').innerText = cost;
            container.querySelector('.p-balance').innerText = budget - cost;
        }

        function deleteRecord(period, index) {
            if(confirm('ç¢ºå®šåˆªé™¤æ­¤é …ç›®ï¼Ÿ')) {
                appData.records[period].splice(index, 1);
                saveData();
                renderPeriodPage(period);
            }
        }

        // è¨­å®šç›¸é—œ
        function loadSettings() {
            document.getElementById('set-summer').value = appData.settings.summer;
            document.getElementById('set-sem1').value = appData.settings.sem1;
            document.getElementById('set-winter').value = appData.settings.winter;
            document.getElementById('set-sem2').value = appData.settings.sem2;
        }

        function updateSettings() {
            appData.settings.summer = document.getElementById('set-summer').value;
            appData.settings.sem1 = document.getElementById('set-sem1').value;
            appData.settings.winter = document.getElementById('set-winter').value;
            appData.settings.sem2 = document.getElementById('set-sem2').value;
            saveData();
        }

        // å­˜æª”èˆ‡å‚™ä»½
        function saveData() {
            localStorage.setItem('schoolFundData', JSON.stringify(appData));
        }

        function clearAllData() {
            if(confirm('è­¦å‘Šï¼é€™å°‡æœƒæ¸…é™¤æ‰€æœ‰è³‡æ–™ä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šå—ï¼Ÿ')) {
                appData = JSON.parse(JSON.stringify(defaultData));
                saveData();
                location.reload();
            }
        }

        function exportJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "funding_backup_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            
            ['summer', 'sem1', 'winter', 'sem2'].forEach(p => {
                // è½‰æ›è³‡æ–™æ ¼å¼é©åˆ Excel
                const sheetData = appData.records[p].map(r => ({
                    "æ—¥æœŸ": r.date,
                    "æ‘˜è¦/å“é …": r.item,
                    "é ˜æ¬¾äºº": r.person,
                    "æ•¸é‡": r.qty,
                    "è«‹é ˜é‡‘é¡": r.claim,
                    "æ¶ˆè²»é‡‘é¡": r.cost
                }));
                const ws = XLSX.utils.json_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(wb, ws, p);
            });

            XLSX.writeFile(wb, "funding_excel_backup.xlsx");
        }

        function importData() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) { alert('è«‹é¸æ“‡æª”æ¡ˆ'); return; }

            const reader = new FileReader();

            if (file.name.endsWith('.json')) {
                reader.onload = function(e) {
                    try {
                        appData = JSON.parse(e.target.result);
                        saveData();
                        alert('JSON åŒ¯å…¥æˆåŠŸï¼');
                        location.reload();
                    } catch(err) { alert('JSON æ ¼å¼éŒ¯èª¤'); }
                };
                reader.readAsText(file);
            } else {
                // Excel åŒ¯å…¥é‚è¼¯
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    // å˜—è©¦è®€å– Excel ä¸­çš„å·¥ä½œè¡¨
                    // å‡è¨­ Sheet åç¨±å°æ‡‰ keyï¼Œæˆ–è€…æŒ‰é †åº 0,1,2,3
                    const sheetMapping = { 'æš‘æœŸ': 'summer', 'ä¸Šå­¸æœŸ': 'sem1', 'å¯’å‡': 'winter', 'ä¸‹å­¸æœŸ': 'sem2' };
                    let importedSomething = false;

                    workbook.SheetNames.forEach(sheetName => {
                        // æ¨¡ç³ŠåŒ¹é…ï¼šæª¢æŸ¥ sheetName æ˜¯å¦åŒ…å«é—œéµå­—
                        let key = null;
                        if(sheetName.includes('æš‘')) key = 'summer';
                        else if(sheetName.includes('ä¸Š')) key = 'sem1';
                        else if(sheetName.includes('å¯’')) key = 'winter';
                        else if(sheetName.includes('ä¸‹')) key = 'sem2';

                        if(key) {
                            const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                            // æ¬„ä½å°æ‡‰ (Mapping)
                            appData.records[key] = jsonData.map(row => ({
                                date: formatDate(row['æ—¥æœŸ'] || row['Date'] || ''), // è™•ç† Excel æ—¥æœŸæ ¼å¼
                                item: row['æ‘˜è¦'] || row['å“é …'] || row['Item'] || '',
                                person: row['é ˜æ¬¾äºº'] || row['å°è±¡'] || '',
                                qty: row['æ•¸é‡'] || 1,
                                claim: row['è«‹é ˜é‡‘é¡'] || row['è«‹é ˜'] || 0,
                                cost: row['æ¶ˆè²»é‡‘é¡'] || row['æ ¸éŠ·'] || row['å¯¦éš›é‡‘é¡'] || 0
                            }));
                            importedSomething = true;
                        }
                    });

                    if(importedSomething) {
                        saveData();
                        alert('Excel åŒ¯å…¥æˆåŠŸï¼');
                        location.reload();
                    } else {
                        alert('æ‰¾ä¸åˆ°å°æ‡‰çš„å·¥ä½œè¡¨åç¨± (éœ€åŒ…å« æš‘/ä¸Š/å¯’/ä¸‹)');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }

        // è¼”åŠ©ï¼šExcel æ—¥æœŸæ ¼å¼è½‰æ›
        function formatDate(excelDate) {
            if(!excelDate) return '';
            if(typeof excelDate === 'string') return excelDate;
            // Excel åºåˆ—å€¼è½‰ JS Date
            const date = new Date(Math.round((excelDate - 25569)*86400*1000));
            return date.toISOString().split('T')[0];
        }

    </script>
</body>
</html>
