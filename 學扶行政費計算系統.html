<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>06 å­¸æ‰¶ç¶“è²»ä½¿ç”¨ç´€éŒ„ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f4f7f6;
            --text-color: #333;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
            --border-color: #ddd;
        }

        body { font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; display: flex; height: 100vh; color: var(--text-color); }
        
        /* å´é‚Šæ¬„ */
        .sidebar { width: 250px; background-color: var(--primary-color); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); overflow-y: auto; }
        .sidebar h2 { font-size: 1.4rem; margin-bottom: 30px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
        .nav-btn { background: none; border: none; color: rgba(255,255,255,0.7); padding: 15px; text-align: left; cursor: pointer; font-size: 1rem; transition: 0.3s; border-radius: 5px; margin-bottom: 5px; display: flex; align-items: center; }
        .nav-btn i { margin-right: 10px; width: 20px; text-align: center; }
        .nav-btn:hover, .nav-btn.active { background-color: var(--accent-color); color: white; font-weight: bold; }
        .nav-footer { margin-top: auto; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px; }

        /* ä¸»å…§å®¹å€ */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; }
        .page { display: none; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* å¡ç‰‡èˆ‡å„€è¡¨æ¿ */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border-left: 5px solid var(--accent-color); transition: transform 0.2s; }
        .card:hover { transform: translateY(-3px); }
        .card h3 { margin-top: 0; color: #7f8c8d; font-size: 1rem; display: flex; justify-content: space-between; align-items: center; }
        .card .value { font-size: 1.8rem; font-weight: bold; color: var(--primary-color); margin: 10px 0; }
        .card .sub-info { font-size: 0.9rem; color: #666; display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; }

        /* è¡¨æ ¼æ¨£å¼ */
        .table-container { overflow-x: auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; white-space: nowrap; }
        tr:hover { background-color: #f8f9fa; }
        
        /* è¼¸å…¥æ¡†å„ªåŒ– */
        input[type="text"], input[type="number"], input[type="date"] {
            width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 0.95rem;
        }
        input:focus { border-color: var(--accent-color); outline: none; }

        /* æŒ‰éˆ• */
        .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; color: white; transition: 0.2s; display: inline-flex; align-items: center; gap: 5px; }
        .btn-primary { background-color: var(--accent-color); }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-secondary { background-color: #95a5a6; }
        .btn:hover { opacity: 0.9; }
        .action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: white; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* è¨­å®šé é¢ */
        .settings-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--primary-color); }

        /* çµ±è¨ˆåˆ— */
        .summary-bar { display: flex; gap: 20px; background: #eaf2f8; padding: 15px; border-radius: 8px; border-left: 5px solid var(--primary-color); margin-bottom: 20px; flex-wrap: wrap; }
        .summary-item b { color: var(--primary-color); }

        /* ç°½åæ¬„ä½ (é è¨­éš±è—) */
        .col-signature { display: none; }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ (A4 æœ€ä½³åŒ–) --- */
        @media print {
            @page { size: A4; margin: 1cm; }
            body { background: white; color: black; display: block; height: auto; font-size: 12pt; }
            .sidebar, .action-bar, .no-print, .btn { display: none !important; }
            .main-content { padding: 0; margin: 0; overflow: visible; }
            .card { box-shadow: none; border: none; padding: 0; margin-bottom: 20px; }
            
            /* æ¨™é¡Œé¡¯ç¤º */
            h2.page-title { text-align: center; font-size: 18pt; margin: 0 0 20px 0; text-decoration: underline; }
            
            /* è¡¨æ ¼åˆ—å°å„ªåŒ– */
            .table-container { box-shadow: none; overflow: visible; }
            table { width: 100%; border: 2px solid black; font-size: 11pt; }
            th, td { border: 1px solid black; padding: 6px; color: black; }
            th { background-color: #eee !important; -webkit-print-color-adjust: exact; text-align: center; }
            
            /* é—œéµï¼šéš±è—æ¶ˆè²»é‡‘é¡ï¼Œé¡¯ç¤ºç°½åæ¬„ */
            .col-actual-cost { display: none !important; }
            .col-signature { display: table-cell !important; width: 100px; text-align: center; }
            .col-date { width: 80px; } /* æ—¥æœŸæ¬„ä½ç¸®å° */
            
            /* è¼¸å…¥æ¡†è½‰ç´”æ–‡å­— (çœ‹èµ·ä¾†åƒåˆ—å°å ±è¡¨) */
            input { border: none; background: transparent; padding: 0; width: auto; font-family: inherit; font-size: inherit; text-align: center; }
            /* å¼·åˆ¶æŸäº›æ¬„ä½é å·¦æˆ–é å³ */
            td:nth-child(2) input { text-align: left; } /* å“é … */
            
            /* é å°¾ç°½æ ¸ */
            .print-footer { position: fixed; bottom: 0; width: 100%; text-align: center; font-size: 12pt; display: block !important; padding-top: 20px; }
        }
        .print-footer { display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>ğŸ’° å­¸æ‰¶ç¶“è²»ç³»çµ±</h2>
        <button class="nav-btn active" onclick="showPage('dashboard')"><i>ğŸ“Š</i> ç¸½è¦½å„€è¡¨æ¿</button>
        <button class="nav-btn" onclick="showPage('summer')"><i>â˜€ï¸</i> æš‘æœŸç¶“è²»</button>
        <button class="nav-btn" onclick="showPage('sem1')"><i>ğŸ‚</i> ä¸Šå­¸æœŸç¶“è²»</button>
        <button class="nav-btn" onclick="showPage('winter')"><i>â„ï¸</i> å¯’å‡ç¶“è²»</button>
        <button class="nav-btn" onclick="showPage('sem2')"><i>ğŸŒ±</i> ä¸‹å­¸æœŸç¶“è²»</button>
        
        <div class="nav-footer">
            <button class="nav-btn" onclick="showPage('settings')"><i>âš™ï¸</i> é ç®—è¨­å®š</button>
            <button class="nav-btn" onclick="showPage('backup')"><i>ğŸ’¾</i> å‚™ä»½èˆ‡é‚„åŸ</button>
        </div>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="page active">
            <h1 class="page-title">ç¶“è²»ä½¿ç”¨ç¸½è¦½</h1>
            <div class="dashboard-grid" id="dashboard-cards">
                </div>
            
            <div class="card">
                <h3>ğŸ’° å…¨å¹´åº¦åˆè¨ˆ</h3>
                <div style="display:flex; justify-content:space-around; flex-wrap:wrap; padding: 15px 0;">
                    <div style="text-align:center; padding:10px;">
                        <span style="color:#7f8c8d;">ç¸½è¡Œæ”¿è²»é ç®—</span><br>
                        <span id="total-budget" class="value">0</span>
                    </div>
                    <div style="text-align:center; padding:10px;">
                        <span style="color:#7f8c8d;">ç¸½è«‹é ˜é‡‘é¡ (ç™¼å‡º)</span><br>
                        <span id="total-claim" class="value" style="color:var(--accent-color)">0</span>
                    </div>
                    <div style="text-align:center; padding:10px;">
                        <span style="color:#7f8c8d;">ç¸½å¯¦éš›æ¶ˆè²»</span><br>
                        <span id="total-cost" class="value" style="color:var(--danger-color)">0</span>
                    </div>
                    <div style="text-align:center; padding:10px;">
                        <span style="color:#7f8c8d;">ç¸½å‰©é¤˜ç¶“è²»</span><br>
                        <span id="total-balance" class="value" style="color:var(--success-color)">0</span>
                    </div>
                </div>
            </div>
        </div>

        <div id="period-template" style="display:none;">
            <div class="action-bar no-print">
                <h2 class="page-title" style="margin:0;">ç¶“è²»æ˜ç´°</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="openAddModal()">â• æ–°å¢å“é …</button>
                    <button class="btn btn-secondary" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å°é ˜æ¸…å†Š</button>
                </div>
            </div>

            <h2 class="page-title" style="display:none; display: block;"></h2>

            <div class="summary-bar no-print">
                <span class="summary-item">é ç®—ï¼š$<span class="p-budget">0</span></span>
                <span class="summary-item">å·²è«‹é ˜(çµ¦è€å¸«)ï¼š$<span class="p-claim">0</span></span>
                <span class="summary-item" style="color:var(--danger-color)">å¯¦éš›æ¶ˆè²»ï¼š$<span class="p-cost">0</span></span>
                <span class="summary-item" style="color:var(--success-color)">å‰©é¤˜ï¼š$<span class="p-balance">0</span></span>
            </div>

            <div class="table-container">
                <table id="data-table">
                    <thead>
                        <tr>
                            <th width="5%" class="no-print">åº</th>
                            <th width="12%" class="col-date">æ—¥æœŸ</th>
                            <th width="20%">å“é …</th>
                            <th width="12%">å¹´ç´š/ç­ç´š</th>
                            <th width="12%">æ•™å¸«</th>
                            <th width="10%">è«‹é ˜é‡‘é¡<br><small>(çµ¦è€å¸«)</small></th>
                            <th width="10%" class="col-actual-cost">æ¶ˆè²»é‡‘é¡<br><small>(å¯¦éš›)</small></th>
                            <th width="12%" class="col-signature">ç°½ç« </th> <th width="8%" class="no-print">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            
            <div class="print-footer">
                <p>æ‰¿è¾¦äººï¼š________________ &nbsp;&nbsp;&nbsp;&nbsp; ä¸»ä»»ï¼š________________ &nbsp;&nbsp;&nbsp;&nbsp; æ ¡é•·ï¼š________________</p>
            </div>
        </div>

        <div id="summer" class="page period-page"></div>
        <div id="sem1" class="page period-page"></div>
        <div id="winter" class="page period-page"></div>
        <div id="sem2" class="page period-page"></div>

        <div id="settings" class="page">
            <h1 class="page-title">âš™ï¸ è¡Œæ”¿è²»é ç®—è¨­å®š</h1>
            <div class="card settings-grid">
                <div class="form-group">
                    <label>â˜€ï¸ æš‘æœŸ è¡Œæ”¿è²»é ç®—</label>
                    <input type="number" id="set-summer" onchange="updateSettings()">
                </div>
                <div class="form-group">
                    <label>ğŸ‚ ä¸Šå­¸æœŸ è¡Œæ”¿è²»é ç®—</label>
                    <input type="number" id="set-sem1" onchange="updateSettings()">
                </div>
                <div class="form-group">
                    <label>â„ï¸ å¯’å‡ è¡Œæ”¿è²»é ç®—</label>
                    <input type="number" id="set-winter" onchange="updateSettings()">
                </div>
                <div class="form-group">
                    <label>ğŸŒ± ä¸‹å­¸æœŸ è¡Œæ”¿è²»é ç®—</label>
                    <input type="number" id="set-sem2" onchange="updateSettings()">
                </div>
            </div>
        </div>

        <div id="backup" class="page">
            <h1 class="page-title">ğŸ’¾ å‚™ä»½èˆ‡é‚„åŸ</h1>
            
            <div class="card" style="margin-bottom: 20px;">
                <h3>ğŸ“¥ åŒ¯å…¥ Excel æª”æ¡ˆ</h3>
                <p>è«‹ä¸Šå‚³æ‚¨è¨˜éŒ„çš„ Excel æª”ã€‚ç³»çµ±æœƒè‡ªå‹•è¾¨è­˜ã€Œæš‘æœŸã€ä¸Šå­¸æœŸã€å¯’å‡ã€ä¸‹å­¸æœŸã€ç­‰å·¥ä½œè¡¨ã€‚</p>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="file" id="fileInput" accept=".json, .xlsx, .xls, .csv">
                    <button class="btn btn-primary" onclick="importData()">é–‹å§‹è®€å–</button>
                </div>
            </div>

            <div class="card" style="margin-bottom: 20px;">
                <h3>ğŸ“¤ è³‡æ–™å‚™ä»½</h3>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-success" onclick="exportJSON()">ä¸‹è¼‰ JSON (å®Œæ•´å‚™ä»½)</button>
                    <button class="btn btn-success" onclick="exportExcel()">ä¸‹è¼‰ Excel (æª¢è¦–ç”¨)</button>
                </div>
            </div>

            <div class="card" style="border-left-color: var(--danger-color);">
                <h3 style="color: var(--danger-color);">âš ï¸ å±éšªå€åŸŸ</h3>
                <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ ä¸€éµæ¸…ç©ºé‡è£½æ‰€æœ‰è³‡æ–™</button>
            </div>
        </div>

    </div>

    <script>
        // è³‡æ–™çµæ§‹
        const defaultData = {
            settings: { summer: 0, sem1: 0, winter: 0, sem2: 0 },
            records: { summer: [], sem1: [], winter: [], sem2: [] }
        };

        let appData = JSON.parse(localStorage.getItem('schoolFundData_v2')) || JSON.parse(JSON.stringify(defaultData));
        
        // é é¢è¼‰å…¥åˆå§‹åŒ–
        window.onload = function() {
            renderDashboard();
            loadSettings();
            renderAllPeriods();
        };

        // å°èˆªåˆ‡æ›
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            const btnMap = {'dashboard':0, 'summer':1, 'sem1':2, 'winter':3, 'sem2':4, 'settings':5, 'backup':6};
            const btnIndex = Object.keys(btnMap).indexOf(pageId);
            
            // ä¿®æ­£æŒ‰éˆ•å°æ‡‰ (å› ç‚ºæœ‰ footer)
            const btns = document.querySelectorAll('.nav-btn');
            // ç°¡å–®å°æ‡‰é‚è¼¯
            btns.forEach(btn => {
                if(btn.getAttribute('onclick').includes(pageId)) btn.classList.add('active');
            });

            if(['summer', 'sem1', 'winter', 'sem2'].includes(pageId)) {
                renderPeriodPage(pageId);
                document.getElementById(pageId).classList.add('active');
            } else {
                document.getElementById(pageId).classList.add('active');
                if(pageId === 'dashboard') renderDashboard();
            }
        }

        // æ¸²æŸ“å„€è¡¨æ¿
        function renderDashboard() {
            const periods = [
                {k:'summer', name:'â˜€ï¸ æš‘æœŸ'}, {k:'sem1', name:'ğŸ‚ ä¸Šå­¸æœŸ'},
                {k:'winter', name:'â„ï¸ å¯’å‡'}, {k:'sem2', name:'ğŸŒ± ä¸‹å­¸æœŸ'}
            ];
            
            let html = '';
            let totalB = 0, totalClaim = 0, totalCost = 0;

            periods.forEach(p => {
                const budget = parseFloat(appData.settings[p.k]) || 0;
                const recs = appData.records[p.k];
                const claim = recs.reduce((sum, r) => sum + (parseFloat(r.claim)||0), 0);
                const cost = recs.reduce((sum, r) => sum + (parseFloat(r.cost)||0), 0);
                const bal = budget - cost;

                totalB += budget; totalClaim += claim; totalCost += cost;

                html += `
                <div class="card" onclick="showPage('${p.k}')" style="cursor:pointer;">
                    <h3>${p.name} <span style="font-size:0.8rem">é ç®— $${budget.toLocaleString()}</span></h3>
                    <div class="value">$${cost.toLocaleString()}</div>
                    <div class="sub-info">
                        <span>è«‹é ˜: $${claim.toLocaleString()}</span>
                        <span style="color:${bal >= 0 ? 'green':'red'}">å‰©é¤˜: $${bal.toLocaleString()}</span>
                    </div>
                </div>`;
            });

            document.getElementById('dashboard-cards').innerHTML = html;
            document.getElementById('total-budget').innerText = `$${totalB.toLocaleString()}`;
            document.getElementById('total-claim').innerText = `$${totalClaim.toLocaleString()}`;
            document.getElementById('total-cost').innerText = `$${totalCost.toLocaleString()}`;
            document.getElementById('total-balance').innerText = `$${(totalB - totalCost).toLocaleString()}`;
        }

        // æ¸²æŸ“å„æœŸæ˜ç´°
        function renderPeriodPage(period) {
            const container = document.getElementById(period);
            const template = document.getElementById('period-template').innerHTML;
            const titles = {'summer':'æš‘æœŸ', 'sem1':'ä¸Šå­¸æœŸ', 'winter':'å¯’å‡', 'sem2':'ä¸‹å­¸æœŸ'};
            
            if(!container.innerHTML) {
                container.innerHTML = template;
                // è¨­å®šæŒ‰éˆ•äº‹ä»¶
                container.querySelector('.btn-primary').onclick = () => addItem(period);
            }

            // æ›´æ–°æ¨™é¡Œ (å«åˆ—å°æ¨™é¡Œ)
            container.querySelectorAll('.page-title').forEach(el => el.innerText = titles[period] + " è¡Œæ”¿è²»ç”¨å°é ˜æ¸…å†Š");

            // è¨ˆç®—çµ±è¨ˆ
            const budget = parseFloat(appData.settings[period]) || 0;
            const records = appData.records[period];
            const claim = records.reduce((s, r) => s + (parseFloat(r.claim)||0), 0);
            const cost = records.reduce((s, r) => s + (parseFloat(r.cost)||0), 0);

            container.querySelector('.p-budget').innerText = budget.toLocaleString();
            container.querySelector('.p-claim').innerText = claim.toLocaleString();
            container.querySelector('.p-cost').innerText = cost.toLocaleString();
            container.querySelector('.p-balance').innerText = (budget - cost).toLocaleString();

            // æ¸²æŸ“è¡¨æ ¼å…§å®¹
            const tbody = container.querySelector('tbody');
            tbody.innerHTML = '';
            records.forEach((r, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="no-print">${index + 1}</td>
                    <td><input type="text" value="${r.date||''}" placeholder="æ—¥æœŸ" onchange="updateRecord('${period}', ${index}, 'date', this.value)"></td>
                    <td><input type="text" value="${r.item||''}" placeholder="è¼¸å…¥æ‘˜è¦" onchange="updateRecord('${period}', ${index}, 'item', this.value)"></td>
                    <td><input type="text" value="${r.target||''}" placeholder="ç­ç´š" onchange="updateRecord('${period}', ${index}, 'target', this.value)"></td>
                    <td><input type="text" value="${r.person||''}" placeholder="æ•™å¸«å§“å" onchange="updateRecord('${period}', ${index}, 'person', this.value)"></td>
                    <td><input type="number" value="${r.claim}" onchange="updateRecord('${period}', ${index}, 'claim', this.value)"></td>
                    <td class="col-actual-cost"><input type="number" value="${r.cost}" style="color:var(--danger-color)" onchange="updateRecord('${period}', ${index}, 'cost', this.value)"></td>
                    <td class="col-signature"></td>
                    <td class="no-print"><button class="btn btn-danger" style="padding:4px 8px;" onclick="deleteRecord('${period}', ${index})">Ã—</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderAllPeriods() {
            ['summer', 'sem1', 'winter', 'sem2'].forEach(p => renderPeriodPage(p));
        }

        // è³‡æ–™ CRUD
        function addItem(period) {
            appData.records[period].push({
                date: '', item: '', target: '', person: '', claim: 0, cost: 0
            });
            saveData();
            renderPeriodPage(period);
        }

        function updateRecord(period, index, field, value) {
            appData.records[period][index][field] = value;
            saveData();
            // æ›´æ–°ä¸Šæ–¹çµ±è¨ˆåˆ—æ•¸å­—
            const budget = parseFloat(appData.settings[period]) || 0;
            const records = appData.records[period];
            const claim = records.reduce((s, r) => s + (parseFloat(r.claim)||0), 0);
            const cost = records.reduce((s, r) => s + (parseFloat(r.cost)||0), 0);
            
            const container = document.getElementById(period);
            container.querySelector('.p-claim').innerText = claim.toLocaleString();
            container.querySelector('.p-cost').innerText = cost.toLocaleString();
            container.querySelector('.p-balance').innerText = (budget - cost).toLocaleString();
        }

        function deleteRecord(period, index) {
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†é …ç›®å—ï¼Ÿ')) {
                appData.records[period].splice(index, 1);
                saveData();
                renderPeriodPage(period);
            }
        }

        // è¨­å®š
        function loadSettings() {
            document.getElementById('set-summer').value = appData.settings.summer;
            document.getElementById('set-sem1').value = appData.settings.sem1;
            document.getElementById('set-winter').value = appData.settings.winter;
            document.getElementById('set-sem2').value = appData.settings.sem2;
        }

        function updateSettings() {
            appData.settings.summer = document.getElementById('set-summer').value;
            appData.settings.sem1 = document.getElementById('set-sem1').value;
            appData.settings.winter = document.getElementById('set-winter').value;
            appData.settings.sem2 = document.getElementById('set-sem2').value;
            saveData();
        }

        function saveData() {
            localStorage.setItem('schoolFundData_v2', JSON.stringify(appData));
        }

        function clearAllData() {
            if(confirm('âš ï¸ è­¦å‘Šï¼šæ‰€æœ‰è³‡æ–™å°‡è¢«æ¸…ç©ºä¸”ç„¡æ³•å¾©åŸï¼ç¢ºå®šå—ï¼Ÿ')) {
                appData = JSON.parse(JSON.stringify(defaultData));
                saveData();
                location.reload();
            }
        }

        // åŒ¯å‡ºåŠŸèƒ½
        function exportJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
            const node = document.createElement('a');
            node.href = dataStr;
            node.download = `å­¸æ‰¶ç¶“è²»å‚™ä»½_${new Date().toISOString().slice(0,10)}.json`;
            node.click();
        }

        function exportExcel() {
            const wb = XLSX.utils.book_new();
            ['summer', 'sem1', 'winter', 'sem2'].forEach(p => {
                const sheetData = appData.records[p].map(r => ({
                    "æ—¥æœŸ": r.date,
                    "å“é …": r.item,
                    "å¹´ç´š/ç­ç´š": r.target,
                    "æ•™å¸«": r.person,
                    "è«‹é ˜é‡‘é¡": r.claim,
                    "æ¶ˆè²»é‡‘é¡": r.cost
                }));
                const ws = XLSX.utils.json_to_sheet(sheetData);
                XLSX.utils.book_append_sheet(wb, ws, p);
            });
            XLSX.writeFile(wb, "å­¸æ‰¶ç¶“è²»ç´€éŒ„.xlsx");
        }

        // åŒ¯å…¥é‚è¼¯ (å¢å¼·ç‰ˆï¼Œé©æ‡‰ä½ çš„æª”æ¡ˆæ ¼å¼)
        function importData() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            if (!file) { alert('è«‹é¸æ“‡æª”æ¡ˆ'); return; }

            const reader = new FileReader();

            if (file.name.endsWith('.json')) {
                reader.onload = function(e) {
                    try {
                        appData = JSON.parse(e.target.result);
                        saveData();
                        alert('JSON å‚™ä»½é‚„åŸæˆåŠŸï¼');
                        location.reload();
                    } catch(err) { alert('JSON æ ¼å¼éŒ¯èª¤'); }
                };
                reader.readAsText(file);
            } else {
                // Excel/CSV è™•ç†
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    let importedCount = 0;
                    
                    // é—œéµå­—æ˜ å°„
                    const sheetMap = { 'æš‘': 'summer', 'ä¸Š': 'sem1', 'å¯’': 'winter', 'ä¸‹': 'sem2' };

                    workbook.SheetNames.forEach(sheetName => {
                        // åˆ¤æ–·å±¬æ–¼å“ªå€‹å­¸æœŸ
                        let periodKey = null;
                        for(let k in sheetMap) {
                            if(sheetName.includes(k)) periodKey = sheetMap[k];
                        }

                        if(periodKey) {
                            const ws = workbook.Sheets[sheetName];
                            // è½‰æˆ Array of Arrays ä»¥ä¾¿æ‰¾è¡¨é ­
                            const rows = XLSX.utils.sheet_to_json(ws, {header: 1});
                            
                            // å°‹æ‰¾è¡¨é ­æ‰€åœ¨çš„åˆ— (æ‰¾å«æœ‰ "ç·¨è™Ÿ" æˆ– "å“é …" çš„é‚£ä¸€åˆ—)
                            let headerRowIndex = 0;
                            rows.forEach((row, idx) => {
                                const rowStr = JSON.stringify(row);
                                if(rowStr.includes('ç·¨è™Ÿ') && rowStr.includes('å“é …')) {
                                    headerRowIndex = idx;
                                }
                            });

                            // å¾è¡¨é ­åˆ—é–‹å§‹è®€å–è³‡æ–™
                            const jsonData = XLSX.utils.sheet_to_json(ws, {range: headerRowIndex});

                            // è½‰æ›è³‡æ–™ (è™•ç†ç‰¹æ®Šæ›è¡Œæ¬„ä½åç¨±)
                            appData.records[periodKey] = jsonData.map(row => {
                                // æ¨¡ç³ŠåŒ¹é…æ¬„ä½åç¨± (ç§»é™¤æ›è¡Œèˆ‡ç©ºç™½)
                                const getVal = (keyPart) => {
                                    const key = Object.keys(row).find(k => k.replace(/\s/g, '').includes(keyPart));
                                    return key ? row[key] : '';
                                };

                                return {
                                    date: getVal('æ—¥æœŸ') || '',
                                    item: getVal('å“é …') || '',
                                    target: getVal('ç­ç´š') || getVal('å¹´ç´š') || '',
                                    person: getVal('æ•™å¸«') || '',
                                    claim: parseFloat(getVal('è«‹é ˜')) || 0, // æŠ“ "è«‹é ˜é‡‘é¡"
                                    cost: parseFloat(getVal('æ¶ˆè²»')) || 0   // æŠ“ "æ¶ˆè²»é‡‘é¡"
                                };
                            });
                            importedCount++;
                        }
                    });

                    if(importedCount > 0) {
                        saveData();
                        alert(`æˆåŠŸåŒ¯å…¥ ${importedCount} å€‹å·¥ä½œè¡¨çš„è³‡æ–™ï¼`);
                        location.reload();
                    } else {
                        alert('ç„¡æ³•è­˜åˆ¥å·¥ä½œè¡¨åç¨±ï¼Œè«‹ç¢ºèªåç¨±åŒ…å«ã€Œæš‘ã€ã€ã€Œä¸Šã€ã€ã€Œå¯’ã€ã€ã€Œä¸‹ã€ã€‚');
                    }
                };
                reader.readAsArrayBuffer(file);
            }
        }
    </script>
</body>
</html>
